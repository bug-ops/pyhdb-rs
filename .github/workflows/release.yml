name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build-wheels:
    name: Build wheels (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux glibc
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: auto
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            manylinux: auto
          # Linux musl (Alpine, static builds)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            manylinux: musllinux_1_2
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            manylinux: musllinux_1_2
          # macOS x86_64 (cross-compile on ARM64 runner)
          - os: macos-latest
            target: x86_64-apple-darwin
            manylinux: auto
          # macOS ARM64
          - os: macos-latest
            target: aarch64-apple-darwin
            manylinux: auto
          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            manylinux: auto
          # NOTE: aarch64-pc-windows-msvc disabled until upstream deps
          # (advapi32-sys, username) support Windows ARM64
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          working-directory: python
          target: ${{ matrix.target }}
          args: --release --out dist
          manylinux: ${{ matrix.manylinux }}
          sccache: true
        env:
          SCCACHE_GHA_ENABLED: "true"
      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-${{ matrix.target }}
          path: python/dist/*.whl
          retention-days: 3

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          working-directory: python
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: sdist
          path: python/dist/*.tar.gz
          retention-days: 3

  build-mcp-binaries:
    name: Build MCP server (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (glibc)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
            use_cross: false
          # Linux x86_64 (musl - static binary)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            archive: tar.gz
            use_cross: false
          # Linux aarch64 (glibc)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            archive: tar.gz
            use_cross: true
          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
            use_cross: false
          # macOS ARM64 (M1/M2)
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz
            use_cross: false
          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
            use_cross: false
    steps:
      - uses: actions/checkout@v6
      - uses: moonrepo/setup-rust@v1
        with:
          targets: ${{ matrix.target }}
          bins: cross
          cache-target: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install musl tools (Linux musl)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
      - name: Get binary name
        id: binary
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo "name=hdbconnect-mcp.exe" >> $GITHUB_OUTPUT
          else
            echo "name=hdbconnect-mcp" >> $GITHUB_OUTPUT
          fi
        shell: bash
      - name: Build binary (cross)
        if: matrix.use_cross
        run: cross build --package hdbconnect-mcp --release --target ${{ matrix.target }}
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"
      - name: Build binary (native)
        if: "!matrix.use_cross"
        run: cargo build --package hdbconnect-mcp --release --target ${{ matrix.target }}
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"
      - name: Strip binary (Linux/macOS, native only)
        if: matrix.os != 'windows-latest' && !matrix.use_cross
        run: strip target/${{ matrix.target }}/release/${{ steps.binary.outputs.name }}
      - name: Create archive (Unix)
        if: matrix.archive == 'tar.gz'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../hdbconnect-mcp-${{ matrix.target }}.tar.gz ${{ steps.binary.outputs.name }}
          cd ../../..
          shasum -a 256 hdbconnect-mcp-${{ matrix.target }}.tar.gz > hdbconnect-mcp-${{ matrix.target }}.tar.gz.sha256
      - name: Create archive (Windows)
        if: matrix.archive == 'zip'
        run: |
          cd target/${{ matrix.target }}/release
          7z a ../../../hdbconnect-mcp-${{ matrix.target }}.zip ${{ steps.binary.outputs.name }}
          cd ../../..
          certUtil -hashfile hdbconnect-mcp-${{ matrix.target }}.zip SHA256 > hdbconnect-mcp-${{ matrix.target }}.zip.sha256
        shell: cmd
      - name: Upload archive
        uses: actions/upload-artifact@v6
        with:
          name: mcp-binary-${{ matrix.target }}
          path: hdbconnect-mcp-${{ matrix.target }}.*
          retention-days: 3

  publish-pypi:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    environment: release
    permissions:
      id-token: write
      contents: read
      attestations: write
    steps:
      - name: Download wheels
        uses: actions/download-artifact@v7
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Download sdist
        uses: actions/download-artifact@v7
        with:
          name: sdist
          path: dist
      - name: Generate attestations
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: dist/*
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          attestations: true

  publish-crates:
    name: Publish to crates.io
    needs: [build-wheels, build-mcp-binaries]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: release
    permissions:
      id-token: write  # Required for OIDC trusted publishing to crates.io
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: moonrepo/setup-rust@v1
        with:
          cache: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Verify version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          CARGO_VERSION=$(grep '^version' Cargo.toml | grep -m1 'version' | sed 's/.*version = "\(.*\)".*/\1/')
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi
      # OIDC trusted publishing - no manual token needed
      # Requires trusted publisher configured on crates.io for each crate
      # See .github/TRUSTED_PUBLISHING.md for setup instructions
      - name: Authenticate with crates.io (OIDC)
        uses: rust-lang/crates-io-auth-action@v1
        id: auth
      - name: Publish crates to crates.io
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ steps.auth.outputs.token }}
          ignore-unpublished-changes: true
          publish-delay: 15000  # 15s delay between publishes

  create-release:
    name: Create GitHub Release
    needs: [publish-pypi, publish-crates]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/**/*.whl
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            artifacts/**/*.sha256

  update-release-notes:
    name: Update Release Notes
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Update release with MCP installation instructions
        uses: softprops/action-gh-release@v2
        with:
          append_body: true
          body: |

            ## MCP Server Installation

            ### Binary Installation

            Download the appropriate binary for your platform:

            - **Linux x86_64 (glibc)**: `hdbconnect-mcp-x86_64-unknown-linux-gnu.tar.gz`
            - **Linux x86_64 (musl, static)**: `hdbconnect-mcp-x86_64-unknown-linux-musl.tar.gz`
            - **Linux aarch64**: `hdbconnect-mcp-aarch64-unknown-linux-gnu.tar.gz`
            - **macOS x86_64**: `hdbconnect-mcp-x86_64-apple-darwin.tar.gz`
            - **macOS ARM64**: `hdbconnect-mcp-aarch64-apple-darwin.tar.gz`
            - **Windows x64**: `hdbconnect-mcp-x86_64-pc-windows-msvc.zip`

            Extract and add to your PATH:

            ```bash
            # Linux/macOS
            tar xzf hdbconnect-mcp-*.tar.gz
            sudo mv hdbconnect-mcp /usr/local/bin/

            # Verify installation
            hdbconnect-mcp --version
            ```

            ### Cargo Installation

            ```bash
            cargo install hdbconnect-mcp
            ```

            ### Claude Desktop Integration

            Add to `~/.claude/claude_desktop_config.json`:

            ```json
            {
              "mcpServers": {
                "hana": {
                  "command": "hdbconnect-mcp",
                  "args": [
                    "--url", "hdbsql://user:password@host:39017",
                    "--read-only", "true",
                    "--row-limit", "10000"
                  ]
                }
              }
            }
            ```

            ## Python Package Installation

            ```bash
            pip install pyhdb_rs
            ```

            See [README](https://github.com/bug-ops/pyhdb-rs#readme) for detailed usage.

            ## Checksums

            SHA256 checksums are available for all binary artifacts (`.sha256` files).
